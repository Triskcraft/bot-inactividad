datasource db {
    provider = "postgresql"
}

/// Configuración del cliente de Prisma orientado a TypeScript con soporte
/// para ESM y rutas generadas bajo `src/prisma/generated`.
generator client {
    provider               = "prisma-client"
    engineType             = "client"
    output                 = "./generated"
    runtime                = "nodejs"
    moduleFormat           = "esm"
    generatedFileExtension = "ts"
    importFileExtension    = "ts"
    previewFeatures        = ["typedSql"]
}

/// Periodo de inactividad declarado por un usuario de Discord.
model InactivityPeriod {
    user_id       String   @id
    guild_id      String
    role_snapshot String
    started_at    DateTime @default(now())
    ends_at       DateTime
    source        String
    notified      Boolean  @default(false)

    discord_user DiscordUser @relation(fields: [user_id], references: [id])

    @@map("inactivity_periods")
}

/// Rol monitoreado dentro de un servidor de Discord.
model TrackedRole {
    guild_id   String
    role_id    String
    created_at DateTime @default(now())

    @@id([guild_id, role_id])
    @@map("tracked_roles")
}

/// Instantáneas de actividad/inactividad por rol para graficar tendencias.
model RoleStatistic {
    id             String   @id @default(dbgenerated("snowflake()"))
    guild_id       String
    role_id        String
    inactive_count Int      @default(0)
    active_count   Int      @default(0)
    captured_at    DateTime @default(now())

    @@map("role_statistics")
}

/// Código temporal utilizado para vincular cuentas externas con Discord.
model LinkCode {
    id               String @id @default(dbgenerated("snowflake()"))
    discord_id       String @unique
    discord_nickname String
    code             String @unique

    discord_user DiscordUser @relation(fields: [discord_id], references: [id])

    @@map("link_codes")
}

/// Catálogo de roles disponibles para usuarios de Minecraft.
model Role {
    id   String @id @default(dbgenerated("snowflake()"))
    name String @unique

    linked_roles LinkedRole[]

    @@map("roles")
}

/// Relación N:M entre usuarios de Minecraft y los roles asignados.
model LinkedRole {
    mc_user_uuid String
    role_id      String

    role           Role          @relation(fields: [role_id], references: [id])
    minecraft_user MinecraftUser @relation(fields: [mc_user_uuid], references: [uuid])

    @@id([mc_user_uuid, role_id])
    @@map("linked_roles")
}

/// Medios o enlaces externos asociados a cada jugador de Minecraft.
model Media {
    id           String @id @default(dbgenerated("snowflake()"))
    mc_user_uuid String
    type         String
    url          String

    minecraft_user MinecraftUser @relation(fields: [mc_user_uuid], references: [uuid])

    @@unique([mc_user_uuid, type])
    @@map("medias")
}

/// Información de jugador de Minecraft enlazada con su usuario de Discord.
model MinecraftUser {
    uuid            String @id
    nickname        String
    digs            Int    @default(0)
    description     String @default("")
    discord_user_id String @unique

    discord_user DiscordUser  @relation(fields: [discord_user_id], references: [id])
    linked_roles LinkedRole[]
    medias       Media[]

    @@map("minecraft_users")
}

/// Representa a un usuario de Discord, incluyendo su rango y relaciones.
model DiscordUser {
    id   String @id
    rank String @default("Miembro")

    inactivityPeriods InactivityPeriod[]
    minecraftUser     MinecraftUser?
    linkCode          LinkCode?
    webhookTokens     WebhookToken[]

    @@map("discord_users")
}

model WebhookToken {
    id              String   @id @default(dbgenerated("snowflake()"))
    name            String
    discord_user_id String
    secret          String
    permissions     String[]
    created_at      DateTime @default(now())

    discord_user DiscordUser @relation(fields: [discord_user_id], references: [id])

    @@map("webhook_tokens")
}
