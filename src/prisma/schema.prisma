datasource db {
    provider = "postgresql"
}

generator client {
    provider               = "prisma-client"
    engineType             = "client"
    output                 = "./generated"
    runtime                = "nodejs"
    moduleFormat           = "esm"
    generatedFileExtension = "ts"
    importFileExtension    = "js"
    previewFeatures        = ["typedSql"]
}

model InactivityPeriod {
    user_id       String   @id
    guild_id      String
    role_snapshot String
    started_at    DateTime @default(now())
    ends_at       DateTime
    source        String
    notified      Boolean  @default(false)

    discord_user DiscordUser @relation(fields: [user_id], references: [id])

    @@map("inactivity_periods")
}

model TrackedRole {
    guild_id   String
    role_id    String
    created_at DateTime @default(now())

    @@id([guild_id, role_id])
    @@map("tracked_roles")
}

model RoleStatistic {
    id             String   @id @default(dbgenerated("snowflake()"))
    guild_id       String
    role_id        String
    inactive_count Int      @default(0)
    active_count   Int      @default(0)
    captured_at    DateTime @default(now())

    @@map("role_statistics")
}

model LinkCode {
    id               String @id @default(dbgenerated("snowflake()"))
    discord_id       String @unique
    discord_nickname String
    code             String @unique

    discord_user DiscordUser @relation(fields: [discord_id], references: [id])

    @@map("link_codes")
}

model Role {
    id   String @id @default(dbgenerated("snowflake()"))
    name String @unique

    linked_roles LinkedRole[]

    @@map("roles")
}

model LinkedRole {
    mc_user_uuid String
    role_id      String

    role           Role          @relation(fields: [role_id], references: [id])
    minecraft_user MinecraftUser @relation(fields: [mc_user_uuid], references: [uuid])

    @@id([mc_user_uuid, role_id])
    @@map("linked_roles")
}

model Media {
    id           String @id @default(dbgenerated("snowflake()"))
    mc_user_uuid String
    type         String
    url          String

    minecraft_user MinecraftUser @relation(fields: [mc_user_uuid], references: [uuid])

    @@unique([mc_user_uuid, type])
    @@map("medias")
}

model MinecraftUser {
    uuid            String @id
    nickname        String
    digs            Int    @default(0)
    description     String @default("")
    discord_user_id String @unique

    discord_user DiscordUser  @relation(fields: [discord_user_id], references: [id])
    linked_roles LinkedRole[]
    medias       Media[]

    @@map("minecraft_users")
}

model DiscordUser {
    id   String @id
    rank String @default("Miembro")

    inactivityPeriods InactivityPeriod[]
    minecraftUser     MinecraftUser?
    linkCode          LinkCode?

    @@map("discord_users")
}
